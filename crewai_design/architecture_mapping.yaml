# ============================================================================
# MAPEO DE ARQUITECTURA: Sistema Original ‚Üí Agentes CrewAI
# ============================================================================
# Versi√≥n: 1.0
# Fecha: 2025-12-01

# ============================================================================
# üìê ARQUITECTURA ORIGINAL (Python Modular)
# ============================================================================

original_system:
  components:
    - name: "ContractParser"
      file: "src/contract_parser.py"
      responsibilities:
        - "Extracci√≥n de texto de PDFs usando PyPDF2"
        - "Parsing con regex patterns para identificar campos"
        - "Detecci√≥n de contratos multi-tramo"
        - "C√°lculo de confianza de extracci√≥n"
        - "Generaci√≥n de advertencias para datos ambiguos"
      key_classes:
        - ContratoParseado
        - Tramo
        - Comision
        - Garantia
        - ClausulaPrepago
        - Covenant

    - name: "FinancialCalculator"
      file: "src/financial_calculator.py"
      responsibilities:
        - "Generaci√≥n de tabla de amortizaci√≥n (francesa, bullet, gracia)"
        - "C√°lculo de TEA, CAT, TIR, VPN"
        - "Comparaci√≥n con tasas de mercado (market_rates.json)"
        - "An√°lisis de sensibilidad para tasas variables"
        - "C√°lculo de escenarios de prepago"
      key_classes:
        - ResultadoCalculo
        - FilaAmortizacion

    - name: "RiskAssessor"
      file: "src/risk_assessor.py"
      responsibilities:
        - "Evaluaci√≥n en 5 categor√≠as de riesgo con scoring 0-100"
        - "Identificaci√≥n de red flags con severidad"
        - "C√°lculo de score total ponderado"
        - "Generaci√≥n de recomendaci√≥n estrat√©gica"
        - "An√°lisis de fortalezas y debilidades"
      key_classes:
        - ResultadoRiesgo
        - RedFlag
        - ScoreCategoria

    - name: "ReportGenerator"
      file: "src/report_generator.py"
      responsibilities:
        - "Generaci√≥n de narrativas con templates Jinja2"
        - "Creaci√≥n de PDFs con ReportLab"
        - "Visualizaciones con Plotly"
        - "Sistema de reglas para explicaciones contextuales"
      key_classes:
        - ReportGenerator (con templates integrados)

  data_flow:
    sequence: "PDF ‚Üí Parser ‚Üí Calculator ‚Üí RiskAssessor ‚Üí ReportGenerator ‚Üí UI"

    step_1:
      component: "ContractParser"
      input: "PDF file path"
      output: "ContratoParseado object"

    step_2:
      component: "FinancialCalculator"
      input: "ContratoParseado object"
      output: "ResultadoCalculo object"

    step_3:
      component: "RiskAssessor"
      input: "ContratoParseado + ResultadoCalculo"
      output: "ResultadoRiesgo object"

    step_4:
      component: "ReportGenerator"
      input: "ContratoParseado + ResultadoCalculo + ResultadoRiesgo"
      output: "PDF report + visualizations"

# ============================================================================
# ü§ñ ARQUITECTURA CREWAI (Multi-Agente)
# ============================================================================

crewai_system:
  agents:
    # ------------------------------------------------------------------------
    # AGENTE 1: EXTRACTOR DE DATOS DEL CONTRATO
    # ------------------------------------------------------------------------
    - id: "contract_data_extractor"
      maps_to_component: "ContractParser"
      responsibility_scope: "70% del ContractParser original"

      role: "Contract Data Extraction Specialist"

      primary_responsibilities:
        - "Extraer partes del contrato (prestamista, prestatario)"
        - "Identificar monto principal, moneda, tasa, plazo"
        - "Detectar tipo de tasa y caracter√≠sticas (variable con √≠ndice/spread)"
        - "Extraer garant√≠as con clasificaci√≥n (real/personal/mixta)"
        - "Identificar comisiones con valores y tipo"
        - "Detectar cl√°usulas de prepago, covenants, incumplimiento"
        - "Manejar contratos multi-tramo"

      key_differences_from_original:
        - "No tiene acceso directo a PyPDF2 (recibe texto pre-extra√≠do)"
        - "Debe reportar nivel de confianza POR CAMPO (no global)"
        - "Debe marcar expl√≠citamente campos 'No encontrado' vs 'Ambiguo'"
        - "No usa regex patterns - usa comprensi√≥n sem√°ntica de LLM"

      tools_available:
        - "file_read_tool (leer PDF ya procesado a texto)"
        - "Ninguna herramienta de parsing - usa capacidad nativa del LLM"

      output_format: "JSON estructurado con schema definido"

      validation_requirements:
        - "Cada campo cr√≠tico debe tener confidence_score (0.0-1.0)"
        - "Debe citar fragmento textual del contrato como evidencia"
        - "Debe listar expl√≠citamente campos no encontrados"

    # ------------------------------------------------------------------------
    # AGENTE 2: CALCULADORA FINANCIERA
    # ------------------------------------------------------------------------
    - id: "financial_calculator"
      maps_to_component: "FinancialCalculator"
      responsibility_scope: "100% del FinancialCalculator original"

      role: "Financial Metrics Calculator"

      primary_responsibilities:
        - "Generar tabla de amortizaci√≥n completa"
        - "Calcular CAT, TEA, TIR, VPN con precisi√≥n >99%"
        - "Comparar con tasas de mercado usando market_rates.json"
        - "Generar an√°lisis de sensibilidad (si tasa variable)"
        - "Calcular escenarios de prepago"

      key_differences_from_original:
        - "Recibe JSON del extractor (no objeto Python ContratoParseado)"
        - "Debe validar input antes de calcular (detectar datos faltantes)"
        - "Debe reportar m√©tricas con precisi√≥n decimal exacta"
        - "Debe documentar f√≥rmulas usadas en el output"

      tools_available:
        - "code_interpreter_tool (para c√°lculos matem√°ticos complejos)"
        - "file_read_tool (leer market_rates.json)"

      output_format: "JSON con tabla_amortizacion + m√©tricas + comparaci√≥n"

      validation_requirements:
        - "Tabla de amortizaci√≥n debe sumar exactamente al monto principal"
        - "CAT/TEA deben estar dentro de ¬±0.1% del c√°lculo manual"
        - "Debe explicar cualquier suposici√≥n hecha (ej: fecha inicio)"

    # ------------------------------------------------------------------------
    # AGENTE 3: EVALUADOR DE RIESGOS
    # ------------------------------------------------------------------------
    - id: "risk_evaluator"
      maps_to_component: "RiskAssessor"
      responsibility_scope: "100% del RiskAssessor original"

      role: "Financial Risk Assessment Specialist"

      primary_responsibilities:
        - "Evaluar riesgo en 5 categor√≠as con scoring 0-100"
        - "Identificar red flags con severidad clasificada"
        - "Calcular score total ponderado"
        - "Generar recomendaci√≥n estrat√©gica (Aceptar/Negociar/Rechazar)"
        - "Listar fortalezas, debilidades, puntos de negociaci√≥n"

      key_differences_from_original:
        - "Recibe 2 JSONs (extracci√≥n + c√°lculos) en vez de objetos Python"
        - "Debe explicar razonamiento de cada score asignado"
        - "Debe justificar la recomendaci√≥n estrat√©gica con evidencia"

      tools_available:
        - "file_read_tool (leer risk_factors.json)"

      output_format: "JSON con scores, red_flags, recommendation, reasoning"

      validation_requirements:
        - "Score total debe ser consistente con scores de categor√≠as"
        - "Recomendaci√≥n debe alinearse con score (ej: score <40 ‚Üí NO Aceptar)"
        - "Cada red flag debe tener evidencia del contrato"

    # ------------------------------------------------------------------------
    # AGENTE 4: SINTETIZADOR DE REPORTES
    # ------------------------------------------------------------------------
    - id: "report_synthesizer"
      maps_to_component: "ReportGenerator"
      responsibility_scope: "80% del ReportGenerator original"

      role: "Financial Report Synthesis Expert"

      primary_responsibilities:
        - "Generar resumen ejecutivo contextualizado"
        - "Crear narrativa de an√°lisis financiero"
        - "Sintetizar evaluaci√≥n de riesgos en lenguaje claro"
        - "Proporcionar recomendaciones accionables"
        - "Estructurar reporte en markdown profesional"

      key_differences_from_original:
        - "NO genera PDFs (CrewAI Studio limita herramientas de generaci√≥n)"
        - "NO genera visualizaciones Plotly (se har√°n en post-procesamiento)"
        - "Enfoque en narrativa de calidad vs formato visual"

      tools_available:
        - "file_write_tool (guardar reporte markdown)"

      output_format: "Markdown estructurado + JSON para visualizaciones"

      validation_requirements:
        - "Narrativa debe ser coherente sin contradicciones"
        - "Todas las afirmaciones deben tener evidencia del an√°lisis previo"
        - "Lenguaje debe ser profesional sin especulaci√≥n"

    # ------------------------------------------------------------------------
    # AGENTE 5: INSPECTOR DE CALIDAD (VALIDADOR TEMPORAL)
    # ------------------------------------------------------------------------
    - id: "quality_inspector"
      maps_to_component: "NUEVO - No existe en sistema original"
      responsibility_scope: "Validaci√≥n anti-alucinaci√≥n"

      role: "Quality Assurance and Anti-Hallucination Inspector"

      primary_responsibilities:
        - "Validar precisi√≥n de extracci√≥n comparando con texto original"
        - "Detectar se√±ales de alucinaci√≥n (datos inventados, inferencias sin base)"
        - "Verificar consistencia entre outputs de diferentes agentes"
        - "Validar c√°lculos matem√°ticos"
        - "Generar reporte de validaci√≥n con nivel de confianza"

      usage_pattern: "TEMPORAL - Solo en desarrollo/testing"

      tools_available:
        - "file_read_tool (leer todos los outputs previos)"

      output_format: "Validation report con PASS/FAIL por nivel"

      validation_levels:
        - "NIVEL 1: Formato y estructura correctos"
        - "NIVEL 2: Datos verificables contra fuente"
        - "NIVEL 3: Coherencia entre agentes"
        - "NIVEL 4: Se√±ales de alucinaci√≥n"

# ============================================================================
# üîÑ FLUJO DE TAREAS EN CREWAI
# ============================================================================

task_flow:
  # Tarea 1: Extracci√≥n
  - task_id: "extract_contract_data"
    agent: "contract_data_extractor"
    input: "{contract_text}"
    output: "extracted_data.json"

  # Tarea 2: Validaci√≥n de Extracci√≥n (TEMPORAL)
  - task_id: "validate_extraction"
    agent: "quality_inspector"
    input: "{contract_text} + extracted_data.json"
    output: "extraction_validation_report.md"
    depends_on: ["extract_contract_data"]

  # Tarea 3: C√°lculos Financieros
  - task_id: "calculate_financial_metrics"
    agent: "financial_calculator"
    input: "extracted_data.json"
    output: "financial_calculations.json"
    depends_on: ["extract_contract_data"]

  # Tarea 4: Validaci√≥n de C√°lculos (TEMPORAL)
  - task_id: "validate_calculations"
    agent: "quality_inspector"
    input: "extracted_data.json + financial_calculations.json"
    output: "calculations_validation_report.md"
    depends_on: ["calculate_financial_metrics"]

  # Tarea 5: Evaluaci√≥n de Riesgos
  - task_id: "evaluate_risks"
    agent: "risk_evaluator"
    input: "extracted_data.json + financial_calculations.json"
    output: "risk_assessment.json"
    depends_on: ["calculate_financial_metrics"]

  # Tarea 6: S√≠ntesis de Reporte
  - task_id: "synthesize_report"
    agent: "report_synthesizer"
    input: "extracted_data.json + financial_calculations.json + risk_assessment.json"
    output: "final_report.md"
    depends_on: ["evaluate_risks"]

  # Tarea 7: Validaci√≥n Final (TEMPORAL)
  - task_id: "validate_final_report"
    agent: "quality_inspector"
    input: "Todos los outputs anteriores + final_report.md"
    output: "final_validation_report.md"
    depends_on: ["synthesize_report"]

# ============================================================================
# üìä COMPARACI√ìN DE CAPACIDADES
# ============================================================================

capability_comparison:
  extraction:
    original: "Regex patterns + PyPDF2 directo"
    crewai: "LLM comprensi√≥n sem√°ntica + texto pre-extra√≠do"
    advantage: "CrewAI - M√°s flexible con formatos variados"

  calculations:
    original: "NumPy + f√≥rmulas Python optimizadas"
    crewai: "Code interpreter con validaci√≥n expl√≠cita"
    advantage: "Original - M√°s r√°pido y preciso"

  risk_assessment:
    original: "Reglas hardcoded en Python"
    crewai: "LLM con reglas guiadas por backstory"
    advantage: "CrewAI - M√°s adaptable, mejor razonamiento narrativo"

  reporting:
    original: "Jinja2 + ReportLab + Plotly = PDF completo"
    crewai: "Markdown narrativo (requiere post-procesamiento para PDF)"
    advantage: "Original - Output m√°s profesional directo"

# ============================================================================
# ‚ö†Ô∏è LIMITACIONES CR√çTICAS DE CREWAI VS ORIGINAL
# ============================================================================

crewai_limitations:
  no_direct_pdf_parsing:
    description: "CrewAI Studio no tiene PyPDF2 integrado"
    workaround: "Pre-procesar PDF a texto antes de pasarlo al agente"

  no_numpy_calculations:
    description: "Sin acceso directo a NumPy para c√°lculos optimizados"
    workaround: "Usar code_interpreter_tool con Python est√°ndar"

  no_pdf_generation:
    description: "Sin ReportLab ni capacidad de generar PDFs"
    workaround: "Generar markdown + convertir a PDF en post-procesamiento"

  no_plotly_visualizations:
    description: "Sin capacidad de generar gr√°ficos interactivos"
    workaround: "Exportar datos JSON + generar visualizaciones separadamente"

  slower_execution:
    description: "LLMs son m√°s lentos que c√≥digo Python optimizado"
    impact: "An√°lisis puede tomar 2-5 minutos vs <10 segundos original"

# ============================================================================
# ‚úÖ VENTAJAS DE CREWAI VS ORIGINAL
# ============================================================================

crewai_advantages:
  semantic_understanding:
    description: "LLM puede interpretar lenguaje legal complejo"
    example: "Detectar cl√°usulas impl√≠citas que regex no capturar√≠a"

  adaptability:
    description: "Se adapta a formatos de contrato variados sin c√≥digo nuevo"
    example: "Maneja contratos de diferentes bancos sin modificar reglas"

  narrative_quality:
    description: "Genera narrativas m√°s contextualizadas y profesionales"
    example: "Explica 'por qu√©' una tasa es elevada, no solo 'que' es elevada"

  explainability:
    description: "Puede justificar razonamiento de forma clara"
    example: "Documenta proceso de c√°lculo de score en lenguaje natural"

# ============================================================================
# üéØ ESTRATEGIA DE IMPLEMENTACI√ìN H√çBRIDA (RECOMENDADA)
# ============================================================================

hybrid_approach:
  recommendation: "Usar CrewAI para an√°lisis + Python original para c√°lculos"

  architecture:
    step_1:
      component: "CrewAI: contract_data_extractor"
      task: "Extracci√≥n sem√°ntica del PDF"

    step_2:
      component: "Python: FinancialCalculator (original)"
      task: "C√°lculos matem√°ticos precisos"

    step_3:
      component: "CrewAI: risk_evaluator"
      task: "An√°lisis de riesgos con razonamiento"

    step_4:
      component: "CrewAI: report_synthesizer"
      task: "Generaci√≥n de narrativa"

    step_5:
      component: "Python: ReportGenerator (original)"
      task: "Conversi√≥n a PDF profesional"

  benefits:
    - "Combina flexibilidad de LLMs con precisi√≥n de c√≥digo"
    - "Mantiene rapidez de c√°lculos cr√≠ticos"
    - "Mejora calidad narrativa del reporte"
    - "Reduce riesgo de errores matem√°ticos en LLM"

# ============================================================================
# FIN DE MAPEO DE ARQUITECTURA
# ============================================================================
